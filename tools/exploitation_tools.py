"""
Exploitation Frameworks

This module contains integrations for exploitation frameworks.

Tool Selection Rationale:
- Metasploit: Industry standard exploitation framework with 2000+ exploits.
Most comprehensive exploitation platform available.
"""

import os
import tempfile
import logging
from datetime import datetime
from typing import Dict, Any, Optional, Callable

from .tool_factory import RedTeamToolFactory

logger = logging.getLogger(__name__)


def register_exploitation_tools(factory: RedTeamToolFactory) -> Dict[str, Callable]:
    """
    Register exploitation framework tools with the factory.
    
    Args:
        factory: RedTeamToolFactory instance
        
    Returns:
        Dictionary mapping tool names to functions
    """
    tools = {}
    
    def create_metasploit_exploit():
        """
        Create metasploit_exploit tool.
        
        Why Metasploit: Industry standard exploitation framework with 2000+ exploits.
        Most comprehensive exploitation platform with extensive payload options.
        """
        def metasploit_exploit(target: str, exploit: str, payload: str = "generic/shell_reverse_tcp") -> Dict[str, Any]:
            """Execute Metasploit exploit."""
            logger.info(f"Executing Metasploit exploit: {exploit} on {target}")
            if not factory._check_tool_available("msfconsole"):
                logger.warning("Metasploit not found. Install: apt install metasploit-framework")
                return {"error": "Metasploit not installed", "target": target}
            
            try:
                # Create Metasploit resource script
                with tempfile.NamedTemporaryFile(mode='w', suffix='.rc', delete=False) as f:
                    f.write(f"use {exploit}\n")
                    f.write(f"set RHOSTS {target}\n")
                    f.write(f"set payload {payload}\n")
                    f.write("exploit\n")
                    script_path = f.name
                
                cmd = ["msfconsole", "-r", script_path, "-q"]
                result = factory._run_command(cmd, timeout=20)
                
                os.unlink(script_path)
                
                return {
                    "target": target,
                    "tool": "metasploit",
                    "exploit": exploit,
                    "output": result.stdout[:1000],
                    "timestamp": datetime.now().isoformat()
                }
            except Exception as e:
                logger.error(f"Error running Metasploit: {str(e)}")
                return {"error": str(e), "target": target}
        
        return metasploit_exploit
    
    # Register exploitation tools
    tools['metasploit_exploit'] = create_metasploit_exploit()
    
    return tools


# Export tool names for this category
__all__ = [
    'register_exploitation_tools',
    'metasploit_exploit',
]

