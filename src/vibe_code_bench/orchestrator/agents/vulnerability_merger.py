"""
Vulnerability Merger

Merges vulnerabilities from multiple sources (red team agent, static analysis)
into a unified vulnerability report.
"""

from typing import Dict, List, Any, Optional
from datetime import datetime

from vibe_code_bench.core.logging_setup import get_logger

logger = get_logger(__name__)


def merge_vulnerabilities(
    static_analysis_result: Optional[Dict[str, Any]],
    red_team_result: Optional[Dict[str, Any]],
    red_team_eval: Optional[Dict[str, Any]] = None
) -> Dict[str, Any]:
    """
    Merge vulnerabilities from static analysis and red team agent into unified report.
    
    Args:
        static_analysis_result: Static analysis results with vulnerabilities
        red_team_result: Red team agent results
        red_team_eval: Red team evaluation results (optional, for ground truth comparison)
        
    Returns:
        Merged vulnerability report with unified structure
    """
    all_vulnerabilities = []
    sources = {}
    
    # Collect static analysis vulnerabilities
    if static_analysis_result and static_analysis_result.get("vulnerabilities"):
        static_vulns = static_analysis_result.get("vulnerabilities", [])
        for vuln in static_vulns:
            # Normalize static analysis vulnerability format
            normalized_vuln = {
                "id": vuln.get("id", f"STATIC-{len(all_vulnerabilities) + 1:03d}"),
                "name": vuln.get("description", vuln.get("issue_text", "Unknown vulnerability")),
                "severity": vuln.get("severity", "Medium"),
                "type": vuln.get("type", "Static Analysis"),
                "source": "static_analysis",
                "tool": vuln.get("tool", "unknown"),
                "file": vuln.get("file", vuln.get("path", "unknown")),
                "line": vuln.get("line", 0),
                "description": vuln.get("description", ""),
                "found": True,
                "details": {
                    "tool": vuln.get("tool"),
                    "test_id": vuln.get("test_id"),
                    "rule_id": vuln.get("rule_id"),
                    "package": vuln.get("package"),
                    "message": vuln.get("message", vuln.get("issue_text", ""))
                }
            }
            all_vulnerabilities.append(normalized_vuln)
            sources["static_analysis"] = sources.get("static_analysis", 0) + 1
    
    # Collect red team vulnerabilities from evaluation (if available)
    if red_team_eval and red_team_eval.get("vulnerabilities"):
        red_team_vulns = red_team_eval.get("vulnerabilities", [])
        for vuln in red_team_vulns:
            if vuln.get("found", False):
                # Normalize red team vulnerability format
                normalized_vuln = {
                    "id": vuln.get("id", f"REDTEAM-{len(all_vulnerabilities) + 1:03d}"),
                    "name": vuln.get("name", "Unknown vulnerability"),
                    "severity": vuln.get("severity", "Medium"),
                    "type": vuln.get("type", "Dynamic Testing"),
                    "source": "red_team",
                    "found": True,
                    "description": vuln.get("description", ""),
                    "agent_description": vuln.get("agent_description"),
                    "match_confidence": vuln.get("match_confidence", 1.0),
                    "details": {
                        "ground_truth_match": True,
                        "match_confidence": vuln.get("match_confidence", 1.0)
                    }
                }
                all_vulnerabilities.append(normalized_vuln)
                sources["red_team"] = sources.get("red_team", 0) + 1
    
    # Also collect from red team report if evaluation not available
    elif red_team_result and red_team_result.get("structured_report"):
        structured = red_team_result.get("structured_report", {})
        red_team_vulns = structured.get("vulnerabilities", [])
        for vuln in red_team_vulns:
            if vuln.get("found", False):
                normalized_vuln = {
                    "id": vuln.get("id", f"REDTEAM-{len(all_vulnerabilities) + 1:03d}"),
                    "name": vuln.get("name", "Unknown vulnerability"),
                    "severity": vuln.get("severity", "Medium"),
                    "type": vuln.get("type", "Dynamic Testing"),
                    "source": "red_team",
                    "found": True,
                    "description": vuln.get("description", ""),
                    "agent_description": vuln.get("agent_description"),
                    "details": {}
                }
                all_vulnerabilities.append(normalized_vuln)
                sources["red_team"] = sources.get("red_team", 0) + 1
    
    # Calculate summary statistics
    by_severity = {
        "Critical": [],
        "High": [],
        "Medium": [],
        "Low": []
    }
    
    for vuln in all_vulnerabilities:
        severity = vuln.get("severity", "Medium")
        if severity in by_severity:
            by_severity[severity].append(vuln)
    
    # Group by source
    by_source = {}
    for vuln in all_vulnerabilities:
        source = vuln.get("source", "unknown")
        if source not in by_source:
            by_source[source] = []
        by_source[source].append(vuln)
    
    # Create merged report
    merged_report = {
        "metadata": {
            "timestamp": datetime.now().isoformat(),
            "total_vulnerabilities": len(all_vulnerabilities),
            "sources": sources
        },
        "summary": {
            "total": len(all_vulnerabilities),
            "by_severity": {
                severity: len(vulns)
                for severity, vulns in by_severity.items()
            },
            "by_source": {
                source: len(vulns)
                for source, vulns in by_source.items()
            }
        },
        "vulnerabilities": all_vulnerabilities,
        "by_severity": by_severity,
        "by_source": by_source
    }
    
    logger.info(f"Merged {len(all_vulnerabilities)} vulnerabilities:")
    logger.info(f"  Static Analysis: {sources.get('static_analysis', 0)}")
    logger.info(f"  Red Team: {sources.get('red_team', 0)}")
    logger.info(f"  By Severity: Critical={len(by_severity['Critical'])}, High={len(by_severity['High'])}, Medium={len(by_severity['Medium'])}, Low={len(by_severity['Low'])}")
    
    return merged_report


def generate_merged_vulnerability_report(
    merged_vulns: Dict[str, Any],
    run_id: str,
    url: str
) -> str:
    """
    Generate a human-readable markdown report of merged vulnerabilities.
    
    Args:
        merged_vulns: Merged vulnerability report
        run_id: Run identifier
        url: Target URL
        
    Returns:
        Markdown formatted vulnerability report
    """
    md = []
    
    # Header
    md.append("# Unified Vulnerability Report")
    md.append("")
    md.append("---")
    md.append("")
    
    # Metadata
    md.append("## Metadata")
    md.append("")
    md.append(f"- **Run ID:** `{run_id}`")
    md.append(f"- **Target URL:** {url}")
    md.append(f"- **Report Date:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    md.append("")
    
    # Summary
    summary = merged_vulns.get("summary", {})
    md.append("## Summary")
    md.append("")
    md.append(f"- **Total Vulnerabilities Found:** {summary.get('total', 0)}")
    md.append("")
    
    # By Severity
    md.append("### By Severity")
    md.append("")
    by_severity = summary.get("by_severity", {})
    for severity in ["Critical", "High", "Medium", "Low"]:
        count = by_severity.get(severity, 0)
        if count > 0:
            md.append(f"- **{severity}:** {count}")
    md.append("")
    
    # By Source
    md.append("### By Source")
    md.append("")
    by_source = summary.get("by_source", {})
    for source, count in by_source.items():
        md.append(f"- **{source.replace('_', ' ').title()}:** {count}")
    md.append("")
    
    # Detailed Vulnerabilities by Severity
    by_severity_vulns = merged_vulns.get("by_severity", {})
    for severity in ["Critical", "High", "Medium", "Low"]:
        vulns = by_severity_vulns.get(severity, [])
        if vulns:
            md.append(f"## {severity} Severity Vulnerabilities ({len(vulns)})")
            md.append("")
            
            for vuln in vulns:
                md.append(f"### {vuln.get('id', 'Unknown')}: {vuln.get('name', 'Unknown')}")
                md.append("")
                md.append(f"- **Type:** {vuln.get('type', 'Unknown')}")
                md.append(f"- **Source:** {vuln.get('source', 'unknown').replace('_', ' ').title()}")
                
                if vuln.get("file"):
                    md.append(f"- **File:** {vuln.get('file')}")
                    if vuln.get("line"):
                        md.append(f"- **Line:** {vuln.get('line')}")
                
                if vuln.get("description"):
                    md.append(f"- **Description:** {vuln.get('description')}")
                
                if vuln.get("agent_description"):
                    md.append(f"- **Agent Finding:** {vuln.get('agent_description')}")
                
                if vuln.get("match_confidence"):
                    md.append(f"- **Match Confidence:** {vuln.get('match_confidence'):.2%}")
                
                # Tool-specific details
                details = vuln.get("details", {})
                if details.get("tool"):
                    md.append(f"- **Tool:** {details.get('tool')}")
                if details.get("test_id"):
                    md.append(f"- **Test ID:** {details.get('test_id')}")
                if details.get("rule_id"):
                    md.append(f"- **Rule ID:** {details.get('rule_id')}")
                if details.get("package"):
                    md.append(f"- **Package:** {details.get('package')}")
                
                md.append("")
    
    # Footer
    md.append("---")
    md.append("")
    md.append(f"*Report generated on {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}*")
    
    return "\n".join(md)

